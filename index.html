<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIN Login Debug</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
        }
        
        .header {
            background: #1e293b;
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #cbd5e1;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .current-config {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .config-item {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .config-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .config-label {
            font-weight: 600;
            color: #475569;
            width: 200px;
        }
        
        .config-value {
            flex: 1;
            font-family: monospace;
            word-break: break-all;
        }
        
        .login-section {
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #475569;
        }
        
        input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .debug-log {
            background: #0f172a;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            animation: fadeIn 0.3s;
        }
        
        .log-success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid #10b981;
            color: #10b981;
        }
        
        .log-error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            color: #ef4444;
        }
        
        .log-info {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
            color: #3b82f6;
        }
        
        .log-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
            color: #f59e0b;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .status-connected {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-section {
            margin-top: 30px;
            padding: 20px;
            background: #f0f9ff;
            border-radius: 10px;
            border: 1px solid #bae6fd;
        }
        
        .result-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê PIN Login Debugger</h1>
            <p>Shows encryption, database matching, and connection steps in real-time</p>
        </div>
        
        <div class="content">
            <!-- Current Configuration -->
            <div class="current-config">
                <h2 style="margin-bottom: 20px; color: #1e293b;">üìã Current Configuration</h2>
                <div class="config-item">
                    <div class="config-label">Admin Project URL:</div>
                    <div class="config-value">https://kmtrpnob.supabase.co</div>
                </div>
                <div class="config-item">
                    <div class="config-label">Admin API Key:</div>
                    <div class="config-value">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttdHJwbmtmdGZxa3RobGdjE3NjM2M</div>
                </div>
                <div class="config-item">
                    <div class="config-label">Target Table:</div>
                    <div class="config-value">admin_public (encrypted PINs)</div>
                </div>
                <div class="config-item">
                    <div class="config-label">Running On:</div>
                    <div class="config-value" id="running-on">Checking...</div>
                </div>
                <div class="config-item">
                    <div class="config-label">Connection Status:</div>
                    <div class="config-value">
                        <span class="status-badge status-disconnected" id="conn-status">Not Connected</span>
                    </div>
                </div>
            </div>
            
            <!-- Login Section -->
            <div class="login-section">
                <h2 style="margin-bottom: 20px; color: #1e293b;">üîë Enter PIN to Test</h2>
                <div class="input-group">
                    <label for="pin-input">Your PIN:</label>
                    <input type="password" id="pin-input" placeholder="Enter the PIN from admin_public table">
                </div>
                <button onclick="testLogin()">üîç Test Login Process</button>
            </div>
            
            <!-- Debug Log -->
            <div class="debug-log" id="debug-log">
                <div class="log-entry log-info">
                    [DEBUG] System initialized. Waiting for PIN input...
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="result-section" id="result-section" style="display: none;">
                <h2 style="margin-bottom: 20px; color: #1e293b;">üìä Login Results</h2>
                <div id="results-container"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            adminUrl: 'https://kmtrpnkftfqkthlgfwob.supabase.co',
            adminKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttdHJwbmtmdGZxa3RobGdmd29iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MTgzMzUsImV4cCI6MjA3OTE5NDMzNX0.6aL-nG-srGEqI18Sp5kVCW2mG5f4Z53gF-csMZ7gfI0',
            tableName: 'admin_public'
        };

        // ============================================
        // DEBUG LOGGER
        // ============================================
        const debugLog = document.getElementById('debug-log');
        
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugLog.appendChild(entry);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        // ============================================
        // ENCRYPTION FUNCTION
        // ============================================
        function encrypt(text) {
            log(`Encrypting: "${text}"`, 'info');
            
            if (!text) return '';
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const ch = text[i];
                
                // Lowercase
                if (ch === 'a') result += 'o';
                else if (ch === 'b') result += 'k';
                else if (ch === 'c') result += 'x';
                else if (ch === 'd') result += 'z';
                else if (ch === 'e') result += 'p';
                else if (ch === 'f') result += 'q';
                else if (ch === 'g') result += 'r';
                else if (ch === 'h') result += 's';
                else if (ch === 'i') result += 't';
                else if (ch === 'j') result += 'u';
                else if (ch === 'k') result += 'v';
                else if (ch === 'l') result += 'w';
                else if (ch === 'm') result += 'a';
                else if (ch === 'n') result += 'b';
                else if (ch === 'o') result += 'c';
                else if (ch === 'p') result += 'd';
                else if (ch === 'q') result += 'e';
                else if (ch === 'r') result += 'f';
                else if (ch === 's') result += 'g';
                else if (ch === 't') result += 'h';
                else if (ch === 'u') result += 'i';
                else if (ch === 'v') result += 'j';
                else if (ch === 'w') result += 'l';
                else if (ch === 'x') result += 'm';
                else if (ch === 'y') result += 'n';
                else if (ch === 'z') result += 'y';
                
                // Uppercase
                else if (ch === 'A') result += 'O';
                else if (ch === 'B') result += 'K';
                else if (ch === 'C') result += 'X';
                else if (ch === 'D') result += 'Z';
                else if (ch === 'E') result += 'P';
                else if (ch === 'F') result += 'Q';
                else if (ch === 'G') result += 'R';
                else if (ch === 'H') result += 'S';
                else if (ch === 'I') result += 'T';
                else if (ch === 'J') result += 'U';
                else if (ch === 'K') result += 'V';
                else if (ch === 'L') result += 'W';
                else if (ch === 'M') result += 'A';
                else if (ch === 'N') result += 'B';
                else if (ch === 'O') result += 'C';
                else if (ch === 'P') result += 'D';
                else if (ch === 'Q') result += 'E';
                else if (ch === 'R') result += 'F';
                else if (ch === 'S') result += 'G';
                else if (ch === 'T') result += 'H';
                else if (ch === 'U') result += 'I';
                else if (ch === 'V') result += 'J';
                else if (ch === 'W') result += 'L';
                else if (ch === 'X') result += 'M';
                else if (ch === 'Y') result += 'N';
                else if (ch === 'Z') result += 'Y';
                
                // Digits
                else if (ch === '0') result += '7';
                else if (ch === '1') result += '8';
                else if (ch === '2') result += '9';
                else if (ch === '3') result += '4';
                else if (ch === '4') result += '5';
                else if (ch === '5') result += '6';
                else if (ch === '6') result += '0';
                else if (ch === '7') result += '1';
                else if (ch === '8') result += '2';
                else if (ch === '9') result += '3';
                
                // Symbols unchanged
                else result += ch;
            }
            
            log(`Encrypted result: "${result}"`, 'success');
            return result;
        }

        // ============================================
        // DECRYPTION FUNCTION
        // ============================================
        function decrypt(text) {
            log(`Decrypting: "${text}"`, 'info');
            
            if (!text) return '';
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const ch = text[i];
                
                // Reverse lowercase
                if (ch === 'o') result += 'a';
                else if (ch === 'k') result += 'b';
                else if (ch === 'x') result += 'c';
                else if (ch === 'z') result += 'd';
                else if (ch === 'p') result += 'e';
                else if (ch === 'q') result += 'f';
                else if (ch === 'r') result += 'g';
                else if (ch === 's') result += 'h';
                else if (ch === 't') result += 'i';
                else if (ch === 'u') result += 'j';
                else if (ch === 'v') result += 'k';
                else if (ch === 'w') result += 'l';
                else if (ch === 'a') result += 'm';
                else if (ch === 'b') result += 'n';
                else if (ch === 'c') result += 'o';
                else if (ch === 'd') result += 'p';
                else if (ch === 'e') result += 'q';
                else if (ch === 'f') result += 'r';
                else if (ch === 'g') result += 's';
                else if (ch === 'h') result += 't';
                else if (ch === 'i') result += 'u';
                else if (ch === 'j') result += 'v';
                else if (ch === 'l') result += 'w';
                else if (ch === 'm') result += 'x';
                else if (ch === 'n') result += 'y';
                else if (ch === 'y') result += 'z';
                
                // Reverse uppercase
                else if (ch === 'O') result += 'A';
                else if (ch === 'K') result += 'B';
                else if (ch === 'X') result += 'C';
                else if (ch === 'Z') result += 'D';
                else if (ch === 'P') result += 'E';
                else if (ch === 'Q') result += 'F';
                else if (ch === 'R') result += 'G';
                else if (ch === 'S') result += 'H';
                else if (ch === 'T') result += 'I';
                else if (ch === 'U') result += 'J';
                else if (ch === 'V') result += 'K';
                else if (ch === 'W') result += 'L';
                else if (ch === 'A') result += 'M';
                else if (ch === 'B') result += 'N';
                else if (ch === 'C') result += 'O';
                else if (ch === 'D') result += 'P';
                else if (ch === 'E') result += 'Q';
                else if (ch === 'F') result += 'R';
                else if (ch === 'G') result += 'S';
                else if (ch === 'H') result += 'T';
                else if (ch === 'I') result += 'U';
                else if (ch === 'J') result += 'V';
                else if (ch === 'L') result += 'W';
                else if (ch === 'M') result += 'X';
                else if (ch === 'N') result += 'Y';
                else if (ch === 'Y') result += 'Z';
                
                // Reverse digits
                else if (ch === '7') result += '0';
                else if (ch === '8') result += '1';
                else if (ch === '9') result += '2';
                else if (ch === '4') result += '3';
                else if (ch === '5') result += '4';
                else if (ch === '6') result += '5';
                else if (ch === '0') result += '6';
                else if (ch === '1') result += '7';
                else if (ch === '2') result += '8';
                else if (ch === '3') result += '9';
                
                // Symbols unchanged
                else result += ch;
            }
            
            log(`Decrypted result: "${result}"`, 'success');
            return result;
        }

        // ============================================
        // MAIN LOGIN FUNCTION
        // ============================================
        async function testLogin() {
            const pinInput = document.getElementById('pin-input');
            const pin = pinInput.value.trim();
            
            // Clear previous results
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('results-container').innerHTML = '';
            
            if (!pin) {
                log('‚ùå Please enter a PIN', 'error');
                return;
            }
            
            log('='.repeat(60), 'info');
            log('üöÄ STARTING LOGIN PROCESS', 'info');
            log('='.repeat(60), 'info');
            
            try {
                // Step 1: Encrypt the PIN
                log(`Step 1: Encrypting user PIN`, 'info');
                log(`User entered: "${pin}"`, 'info');
                const encryptedPin = encrypt(pin);
                log(`Encrypted PIN: "${encryptedPin}"`, 'success');
                
                // Step 2: Check admin_public table
                log(`Step 2: Searching admin_public table for encrypted PIN`, 'info');
                log(`Query: SELECT * FROM admin_public WHERE pin_enc = "${encryptedPin}"`, 'info');
                
                const response = await fetch(
                    `${CONFIG.adminUrl}/rest/v1/admin_public?pin_enc=eq.${encodeURIComponent(encryptedPin)}`,
                    {
                        headers: {
                            'apikey': CONFIG.adminKey,
                            'Authorization': `Bearer ${CONFIG.adminKey}`
                        }
                    }
                );
                
                if (!response.ok) {
                    log(`‚ùå Database query failed: ${response.status} ${response.statusText}`, 'error');
                    throw new Error(`Database error: ${response.status}`);
                }
                
                const data = await response.json();
                log(`Database returned ${data.length} matching record(s)`, 'info');
                
                if (data.length === 0) {
                    log('‚ùå No matching PIN found in database', 'error');
                    showResult('error', 'PIN not found', `Encrypted PIN "${encryptedPin}" not found in admin_public table`);
                    return;
                }
                
                const adminRecord = data[0];
                log('‚úÖ PIN found in database!', 'success');
                log(`Record ID: ${adminRecord.id}`, 'info');
                log(`Encrypted URL in DB: ${adminRecord.url_enc ? 'Present' : 'Missing'}`, 'info');
                log(`Encrypted Key in DB: ${adminRecord.key_enc ? 'Present' : 'Missing'}`, 'info');
                
                // Step 3: Decrypt the values
                log(`Step 3: Decrypting URL and API key`, 'info');
                
                if (!adminRecord.url_enc || !adminRecord.key_enc) {
                    log('‚ùå Missing encrypted URL or API key in database', 'error');
                    showResult('error', 'Incomplete record', 'Admin record missing URL or API key');
                    return;
                }
                
                const decryptedUrl = decrypt(adminRecord.url_enc);
                const decryptedKey = decrypt(adminRecord.key_enc);
                
                log(`Decrypted URL: ${decryptedUrl}`, 'success');
                log(`Decrypted API Key: ${decryptedKey.substring(0, 30)}...`, 'success');
                
                // Step 4: Test connection to the decrypted project
                log(`Step 4: Testing connection to decrypted project`, 'info');
                log(`Testing URL: ${decryptedUrl}`, 'info');
                
                const projectResponse = await fetch(
                    `${decryptedUrl}/rest/v1/family_data_responses_gsheet?limit=1`,
                    {
                        headers: {
                            'apikey': decryptedKey,
                            'Authorization': `Bearer ${decryptedKey}`
                        }
                    }
                );
                
                if (projectResponse.ok) {
                    const projectData = await projectResponse.json();
                    log(`‚úÖ Successfully connected to project!`, 'success');
                    log(`Found ${projectData.length} records in family_data_responses_gsheet`, 'success');
                    
                    // Show success results
                    showResult('success', 'Login Successful!', {
                        encryptedPin,
                        decryptedUrl,
                        decryptedKey,
                        recordCount: projectData.length,
                        canAccessForms: true
                    });
                    
                } else {
                    log(`‚ùå Failed to connect to project: ${projectResponse.status}`, 'error');
                    showResult('warning', 'Partial Success', {
                        encryptedPin,
                        decryptedUrl,
                        decryptedKey,
                        error: `Project connection failed: ${projectResponse.status}`
                    });
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                showResult('error', 'Process Failed', error.message);
            }
            
            log('='.repeat(60), 'info');
            log('üèÅ LOGIN PROCESS COMPLETE', 'info');
            log('='.repeat(60), 'info');
        }

        // ============================================
        // SHOW RESULTS
        // ============================================
        function showResult(type, title, data) {
            const container = document.getElementById('results-container');
            const section = document.getElementById('result-section');
            
            let html = '';
            
            if (type === 'success') {
                html = `
                    <div class="result-item" style="border-left: 4px solid #10b981;">
                        <h3 style="color: #065f46;">‚úÖ ${title}</h3>
                        <p><strong>Encrypted PIN:</strong> ${data.encryptedPin}</p>
                        <p><strong>Decrypted URL:</strong> ${data.decryptedUrl}</p>
                        <p><strong>Decrypted API Key:</strong> ${data.decryptedKey.substring(0, 50)}...</p>
                        <p><strong>Can Access Forms:</strong> ‚úÖ Yes (${data.recordCount} records found)</p>
                        <p><strong>Next Step:</strong> You can now load the form interface</p>
                    </div>
                `;
            } else if (type === 'warning') {
                html = `
                    <div class="result-item" style="border-left: 4px solid #f59e0b;">
                        <h3 style="color: #92400e;">‚ö†Ô∏è ${title}</h3>
                        <p><strong>Encrypted PIN:</strong> ${data.encryptedPin}</p>
                        <p><strong>Decrypted URL:</strong> ${data.decryptedUrl}</p>
                        <p><strong>Issue:</strong> ${data.error}</p>
                        <p><strong>Status:</strong> PIN matched but project connection failed</p>
                    </div>
                `;
            } else {
                html = `
                    <div class="result-item" style="border-left: 4px solid #ef4444;">
                        <h3 style="color: #991b1b;">‚ùå ${title}</h3>
                        <p><strong>Error:</strong> ${data}</p>
                        <p><strong>Status:</strong> Login failed</p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            section.style.display = 'block';
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.onload = function() {
            // Show where we're running from
            const runningOn = document.getElementById('running-on');
            runningOn.textContent = `${window.location.protocol}//${window.location.host}`;
            
            // Test connection to admin project
            testAdminConnection();
            
            // Focus on PIN input
            document.getElementById('pin-input').focus();
        };

        async function testAdminConnection() {
            const status = document.getElementById('conn-status');
            log('Testing connection to admin project...', 'info');
            
            try {
                const response = await fetch(`${CONFIG.adminUrl}/rest/v1/`, {
                    headers: {
                        'apikey': CONFIG.adminKey,
                        'Authorization': `Bearer ${CONFIG.adminKey}`
                    }
                });
                
                if (response.ok) {
                    status.textContent = 'Connected';
                    status.className = 'status-badge status-connected';
                    log('‚úÖ Connected to admin project successfully', 'success');
                } else {
                    status.textContent = 'Connection Failed';
                    status.className = 'status-badge status-disconnected';
                    log(`‚ùå Admin project connection failed: ${response.status}`, 'error');
                }
            } catch (error) {
                status.textContent = 'Network Error';
                status.className = 'status-badge status-disconnected';
                log(`‚ùå Network error: ${error.message}`, 'error');
                log('‚ö†Ô∏è  This is likely a CORS issue. Make sure:', 'warning');
                log('1. You are running from GitHub Pages (not file://)', 'warning');
                log('2. Your GitHub URL is in Supabase CORS settings', 'warning');
            }
        }

        // Allow Enter key to submit
        document.getElementById('pin-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                testLogin();
            }
        });
    </script>
</body>
</html>
