<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIN Login Test - GitHub Pages</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #444;
            margin-top: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        .test-section {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8fafc;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        button:active {
            transform: translateY(0);
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
            display: block;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            display: block;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
            display: block;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
        }
        .status-online {
            background: #d1fae5;
            color: #065f46;
        }
        .status-offline {
            background: #fee2e2;
            color: #991b1b;
        }
        .encryption-demo {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .summary {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .test-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê PIN Login System Test</h1>
        <p style="text-align: center; color: #64748b; margin-bottom: 30px;">
            Testing connection from GitHub Pages to Supabase
        </p>

        <!-- Connection Status -->
        <div class="test-section">
            <h2>üåê Connection Status</h2>
            <div id="connection-status" class="status status-offline">Checking...</div>
            <div id="connection-result" class="result"></div>
            <button onclick="testConnection()">Test Supabase Connection</button>
        </div>

        <!-- Encryption Test -->
        <div class="test-section">
            <h2>üî¢ Encryption Test</h2>
            <p style="color: #64748b; margin-bottom: 15px;">
                Enter PIN to test encryption (matches PostgreSQL function):
            </p>
            <input type="text" id="test-pin" placeholder="Enter PIN (e.g., Admin123)">
            <button onclick="testEncryption()">Test Encryption</button>
            <div id="encryption-result" class="result"></div>
            
            <div class="encryption-demo">
                <strong>Examples:</strong><br>
                ‚Ä¢ "Admin123" ‚Üí "O8ko894"<br>
                ‚Ä¢ "1252" ‚Üí "8969"<br>
                ‚Ä¢ "test" ‚Üí "hpgh"<br>
                ‚Ä¢ "HELLO" ‚Üí "SPWWC"
            </div>
        </div>

        <!-- Full Login Test -->
        <div class="test-section">
            <h2>üîë Full Login Test</h2>
            <p style="color: #64748b; margin-bottom: 15px;">
                Enter your actual PIN from admin_public table:
            </p>
            <input type="password" id="login-pin" placeholder="Enter your actual PIN">
            <button onclick="testLogin()">Test Login</button>
            <div id="login-result" class="result"></div>
        </div>

        <!-- Quick Tests Grid -->
        <div class="test-grid">
            <div class="test-section">
                <h3>üìã Test Common PINs</h3>
                <button onclick="quickTest('Admin123')">Test: Admin123</button>
                <button onclick="quickTest('1252')">Test: 1252</button>
                <button onclick="quickTest('test')">Test: test</button>
                <div id="quick-result" class="result"></div>
            </div>

            <div class="test-section">
                <h3>üîç Check Table Data</h3>
                <button onclick="checkAdminTable()">List All Admin PINs</button>
                <div id="table-result" class="result"></div>
            </div>
        </div>

        <!-- Test Summary -->
        <div class="summary">
            <h2>üìä Test Summary</h2>
            <div class="summary-item">
                <span>GitHub Pages URL:</span>
                <span id="current-url"></span>
            </div>
            <div class="summary-item">
                <span>Supabase Project:</span>
                <span>kmtrpnob.supabase.co</span>
            </div>
            <div class="summary-item">
                <span>Encryption Working:</span>
                <span id="encryption-status">‚ùì</span>
            </div>
            <div class="summary-item">
                <span>Connection Working:</span>
                <span id="connection-summary">‚ùì</span>
            </div>
            <div class="summary-item">
                <span>Admin Table Access:</span>
                <span id="table-status">‚ùì</span>
            </div>
        </div>

        <!-- Instructions -->
        <div style="margin-top: 30px; padding: 20px; background: #f0f9ff; border-radius: 10px; border: 1px solid #bae6fd;">
            <h3>üìù How to Use:</h3>
            <ol style="color: #0369a1; line-height: 1.8;">
                <li>Upload this file to GitHub as <code>index.html</code></li>
                <li>Enable GitHub Pages in repo Settings</li>
                <li>Add your GitHub URL to Supabase CORS settings</li>
                <li>Test each section above</li>
                <li>If tests pass, your main app will work!</li>
            </ol>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const ADMIN_PROJECT = {
            url: 'https://kmtrpnkftfqkthlgfwob.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttdHJwbmtmdGZxa3RobGdmd29iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MTgzMzUsImV4cCI6MjA3OTE5NDMzNX0.6aL-nG-srGEqI18Sp5kVCW2mG5f4Z53gF-csMZ7gfI0'
        };

        // Show current URL
        document.getElementById('current-url').textContent = window.location.origin;

        // ============================================
        // ENCRYPTION FUNCTION (Matches PostgreSQL)
        // ============================================
        function encrypt(text) {
            if (!text) return '';
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const ch = text[i];
                
                // Lowercase
                if (ch === 'a') result += 'o';
                else if (ch === 'b') result += 'k';
                else if (ch === 'c') result += 'x';
                else if (ch === 'd') result += 'z';
                else if (ch === 'e') result += 'p';
                else if (ch === 'f') result += 'q';
                else if (ch === 'g') result += 'r';
                else if (ch === 'h') result += 's';
                else if (ch === 'i') result += 't';
                else if (ch === 'j') result += 'u';
                else if (ch === 'k') result += 'v';
                else if (ch === 'l') result += 'w';
                else if (ch === 'm') result += 'a';
                else if (ch === 'n') result += 'b';
                else if (ch === 'o') result += 'c';
                else if (ch === 'p') result += 'd';
                else if (ch === 'q') result += 'e';
                else if (ch === 'r') result += 'f';
                else if (ch === 's') result += 'g';
                else if (ch === 't') result += 'h';
                else if (ch === 'u') result += 'i';
                else if (ch === 'v') result += 'j';
                else if (ch === 'w') result += 'l';
                else if (ch === 'x') result += 'm';
                else if (ch === 'y') result += 'n';
                else if (ch === 'z') result += 'y';
                
                // Uppercase
                else if (ch === 'A') result += 'O';
                else if (ch === 'B') result += 'K';
                else if (ch === 'C') result += 'X';
                else if (ch === 'D') result += 'Z';
                else if (ch === 'E') result += 'P';
                else if (ch === 'F') result += 'Q';
                else if (ch === 'G') result += 'R';
                else if (ch === 'H') result += 'S';
                else if (ch === 'I') result += 'T';
                else if (ch === 'J') result += 'U';
                else if (ch === 'K') result += 'V';
                else if (ch === 'L') result += 'W';
                else if (ch === 'M') result += 'A';
                else if (ch === 'N') result += 'B';
                else if (ch === 'O') result += 'C';
                else if (ch === 'P') result += 'D';
                else if (ch === 'Q') result += 'E';
                else if (ch === 'R') result += 'F';
                else if (ch === 'S') result += 'G';
                else if (ch === 'T') result += 'H';
                else if (ch === 'U') result += 'I';
                else if (ch === 'V') result += 'J';
                else if (ch === 'W') result += 'L';
                else if (ch === 'X') result += 'M';
                else if (ch === 'Y') result += 'N';
                else if (ch === 'Z') result += 'Y';
                
                // Digits
                else if (ch === '0') result += '7';
                else if (ch === '1') result += '8';
                else if (ch === '2') result += '9';
                else if (ch === '3') result += '4';
                else if (ch === '4') result += '5';
                else if (ch === '5') result += '6';
                else if (ch === '6') result += '0';
                else if (ch === '7') result += '1';
                else if (ch === '8') result += '2';
                else if (ch === '9') result += '3';
                
                // Symbols unchanged
                else result += ch;
            }
            return result;
        }

        // ============================================
        // TEST FUNCTIONS
        // ============================================

        // Test 1: Connection to Supabase
        async function testConnection() {
            const status = document.getElementById('connection-status');
            const result = document.getElementById('connection-result');
            
            status.textContent = 'Testing...';
            status.className = 'status';
            result.className = 'result info';
            result.textContent = 'Testing connection to Supabase...';
            result.style.display = 'block';
            
            try {
                const response = await fetch(`${ADMIN_PROJECT.url}/rest/v1/`, {
                    headers: {
                        'apikey': ADMIN_PROJECT.key,
                        'Authorization': `Bearer ${ADMIN_PROJECT.key}`
                    }
                });
                
                if (response.ok) {
                    status.textContent = '‚úÖ Online';
                    status.className = 'status status-online';
                    result.className = 'result success';
                    result.innerHTML = '‚úÖ Connected to Supabase successfully!<br><br>' +
                                     '<strong>Response Status:</strong> ' + response.status + '<br>' +
                                     '<strong>Protocol:</strong> ' + window.location.protocol + '<br>' +
                                     '<strong>Running on:</strong> ' + window.location.hostname;
                    document.getElementById('connection-summary').textContent = '‚úÖ Working';
                } else {
                    status.textContent = '‚ùå Server Error';
                    status.className = 'status status-offline';
                    result.className = 'result error';
                    result.textContent = `‚ùå Server error: ${response.status}`;
                    document.getElementById('connection-summary').textContent = '‚ùå Failed';
                }
            } catch (error) {
                status.textContent = '‚ùå Network Error';
                status.className = 'status status-offline';
                result.className = 'result error';
                result.innerHTML = `‚ùå Network error: ${error.message}<br><br>` +
                                 '<strong>Common causes:</strong><br>' +
                                 '1. CORS not configured in Supabase<br>' +
                                 '2. Wrong API key<br>' +
                                 '3. Network blocked';
                document.getElementById('connection-summary').textContent = '‚ùå Failed';
            }
        }

        // Test 2: Encryption test
        function testEncryption() {
            const pin = document.getElementById('test-pin').value.trim();
            const result = document.getElementById('encryption-result');
            
            if (!pin) {
                result.className = 'result error';
                result.textContent = '‚ùå Please enter a PIN to test';
                result.style.display = 'block';
                return;
            }
            
            const encrypted = encrypt(pin);
            result.className = 'result success';
            result.innerHTML = `‚úÖ Encryption working!<br><br>` +
                             `<strong>Original:</strong> "${pin}"<br>` +
                             `<strong>Encrypted:</strong> "${encrypted}"`;
            result.style.display = 'block';
            
            document.getElementById('encryption-status').textContent = '‚úÖ Working';
        }

        // Test 3: Full login test
        async function testLogin() {
            const pin = document.getElementById('login-pin').value.trim();
            const result = document.getElementById('login-result');
            
            if (!pin) {
                result.className = 'result error';
                result.textContent = '‚ùå Please enter a PIN';
                result.style.display = 'block';
                return;
            }
            
            result.className = 'result info';
            result.innerHTML = `Encrypting PIN "${pin}"...`;
            result.style.display = 'block';
            
            try {
                const encryptedPin = encrypt(pin);
                result.innerHTML += `<br>Encrypted: "${encryptedPin}"<br>Checking database...`;
                
                const response = await fetch(
                    `${ADMIN_PROJECT.url}/rest/v1/admin_public?pin_enc=eq.${encodeURIComponent(encryptedPin)}`,
                    {
                        headers: {
                            'apikey': ADMIN_PROJECT.key,
                            'Authorization': `Bearer ${ADMIN_PROJECT.key}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.length === 0) {
                        result.className = 'result error';
                        result.innerHTML = `‚ùå PIN not found<br><br>` +
                                         `Encrypted PIN "${encryptedPin}" not in admin_public table`;
                    } else {
                        result.className = 'result success';
                        result.innerHTML = `‚úÖ LOGIN SUCCESSFUL!<br><br>` +
                                         `<strong>Found admin record:</strong><br>` +
                                         `‚Ä¢ Encrypted PIN: ${data[0].pin_enc}<br>` +
                                         `‚Ä¢ Has encrypted URL: ${data[0].url_enc ? 'Yes' : 'No'}<br>` +
                                         `‚Ä¢ Has encrypted key: ${data[0].key_enc ? 'Yes' : 'No'}`;
                    }
                } else {
                    result.className = 'result error';
                    result.textContent = `‚ùå Server error: ${response.status}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `‚ùå Network error: ${error.message}`;
            }
        }

        // Quick test with common PINs
        async function quickTest(pin) {
            const result = document.getElementById('quick-result');
            result.className = 'result info';
            result.innerHTML = `Testing PIN: "${pin}"...`;
            result.style.display = 'block';
            
            try {
                const encryptedPin = encrypt(pin);
                const response = await fetch(
                    `${ADMIN_PROJECT.url}/rest/v1/admin_public?pin_enc=eq.${encodeURIComponent(encryptedPin)}`,
                    {
                        headers: {
                            'apikey': ADMIN_PROJECT.key,
                            'Authorization': `Bearer ${ADMIN_PROJECT.key}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.length > 0) {
                        result.className = 'result success';
                        result.innerHTML = `‚úÖ "${pin}" is a valid admin PIN!`;
                    } else {
                        result.className = 'result error';
                        result.innerHTML = `‚ùå "${pin}" not found in database`;
                    }
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `Error: ${error.message}`;
            }
        }

        // List all admin PINs in table
        async function checkAdminTable() {
            const result = document.getElementById('table-result');
            result.className = 'result info';
            result.innerHTML = 'Fetching admin_public table...';
            result.style.display = 'block';
            
            try {
                const response = await fetch(
                    `${ADMIN_PROJECT.url}/rest/v1/admin_public?select=pin_enc,created_at&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': ADMIN_PROJECT.key,
                            'Authorization': `Bearer ${ADMIN_PROJECT.key}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.length === 0) {
                        result.className = 'result error';
                        result.textContent = '‚ùå No records found in admin_public table';
                        document.getElementById('table-status').textContent = '‚ùå Empty';
                    } else {
                        result.className = 'result success';
                        let html = `‚úÖ Found ${data.length} admin PIN(s):<br><br>`;
                        data.forEach((record, index) => {
                            const date = new Date(record.created_at).toLocaleDateString();
                            html += `${index + 1}. ${record.pin_enc} (Created: ${date})<br>`;
                        });
                        result.innerHTML = html;
                        document.getElementById('table-status').textContent = `‚úÖ ${data.length} records`;
                    }
                } else {
                    result.className = 'result error';
                    result.textContent = `‚ùå Cannot access table: ${response.status}`;
                    document.getElementById('table-status').textContent = '‚ùå Failed';
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `‚ùå Error: ${error.message}`;
                document.getElementById('table-status').textContent = '‚ùå Failed';
            }
        }

        // ============================================
        // INITIAL TESTS ON PAGE LOAD
        // ============================================
        window.onload = function() {
            // Auto-test encryption with example
            const testPin = 'Admin123';
            const encrypted = encrypt(testPin);
            document.getElementById('encryption-status').textContent = 
                encrypted === 'O8ko894' ? '‚úÖ Working' : '‚ùå Mismatch';
            
            // Start connection test
            setTimeout(testConnection, 500);
        };
    </script>
</body>
</html>

